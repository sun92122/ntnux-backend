name: Weekly Crawl and Push TSV

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 9 é»è§¸ç™¼ï¼ˆè‡ºç£æ™‚é–“ï¼‰
    - cron: "0 1 * * 1"
  workflow_dispatch:
    inputs:
      year:
        description: "å­¸å¹´ï¼ˆæ°‘åœ‹å¹´ï¼‰"
        required: false
        default: "114"
      term:
        description: "å­¸æœŸï¼ˆ1=ä¸Šå­¸æœŸ, 2=ä¸‹å­¸æœŸ, 3=æš‘æœŸï¼‰"
        required: false
        default: "1"

jobs:
  crawl-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backend repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync

      - name: Run crawler
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          echo "Crawling data for year $YEAR, term $TERM"
          uv run main.py --year $YEAR --term $TERM --out "output/$YEAR-$TERM" --data "original_data"

      - name: Push original data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add "original_data/$YEAR-$TERM.tsv"
          git commit -m "ğŸ“¦ æ›´æ–°åŸå§‹èª²ç¨‹è³‡æ–™ ${YEAR}-${TERM}" || echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤"
          git push origin main

      - name: Clone frontend repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.FRONTEND_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          git clone git@github.com:sun92122/ntnux-frontend.git frontend-repo

      - name: Copy data to frontend repo
        run: |
          SRC_DIR="output/${YEAR}-${TERM}"
          DEST_DIR="frontend-repo/public/data/${YEAR}-${TERM}"

          mkdir -p "$DEST_DIR"
          cp -r "$SRC_DIR"/*.tsv "$DEST_DIR/"

      - name: Commit and push changes
        run: |
          cd frontend-repo
          git add public/data
          git commit -m "ğŸ“¦ æ›´æ–° ${YEAR}-${TERM} èª²ç¨‹è³‡æ–™" || echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤"
          git push origin main
