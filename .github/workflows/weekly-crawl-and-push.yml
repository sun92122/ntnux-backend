name: Weekly Crawl and Push TSV

on:
  schedule:
    # 每週一早上 9 點觸發（臺灣時間）
    - cron: "0 1 * * 1"
  workflow_dispatch:
    inputs:
      year:
        description: "學年（民國年）"
        required: false
        default: "114"
      term:
        description: "學期（1=上學期, 2=下學期, 3=暑期）"
        required: false
        default: "1"

jobs:
  crawl-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backend repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync

      - name: Run crawler
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          echo "Crawling data for year $YEAR, term $TERM"
          uv run main.py --year $YEAR --term $TERM --out "output/$YEAR-$TERM" --data "original_data"

      - name: Push original data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add "original_data/$YEAR-$TERM.tsv"
          git commit -m "📦 更新原始課程資料 ${YEAR}-${TERM}" || echo "⚠️ 無變更可提交"
          git push origin main

      - name: Clone frontend repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.FRONTEND_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          git clone git@github.com:sun92122/ntnux-frontend.git frontend-repo

      - name: Copy data to frontend repo
        run: |
          SRC_DIR="output/${YEAR}-${TERM}"
          DEST_DIR="frontend-repo/public/data/${YEAR}-${TERM}"

          mkdir -p "$DEST_DIR"
          cp -r "$SRC_DIR"/*.tsv "$DEST_DIR/"

      - name: Commit and push changes
        run: |
          cd frontend-repo
          git add public/data
          git commit -m "📦 更新 ${YEAR}-${TERM} 課程資料" || echo "⚠️ 無變更可提交"
          git push origin main
